#!/bin/vbash
# --- CCDC First 30-Min Hardening Script for VyOS 1.4.3 ---
#
# This script does the following:
# 1. Creates a new admin user ('hazmat') with a placeholder password.
# 2. Disables the default 'vyos' user.
# 3. Changes SSH port to 4971 and blocks root login.
# 4. Disables common unneeded/insecure services.
# 5. Enables the FTP helper module (critical for FTP firewalling).
# 6. Creates firewall groups for your scored services and servers.
# 7. Creates and applies a "default-deny" stateful firewall for WAN_LOCAL and WAN_FORWARD.
# 8. Allows your SSH port (4971) and ICMP (ping) to the router.
# 9. Allows your scored services (HTTP, HTTPS, etc.) to your servers.

source /opt/vyatta/etc/functions/script-template
configure

# === 1. User & Management Hardening ===
# --- !!! CHANGE THIS PASSWORD NOW !!! ---
set system login user hazmat authentication plaintext-password 'CCDC-ChangeMeNow!'
set system login user hazmat level admin
set system login user vyos disable

# Change SSH port and deny root
set service ssh port '4971'
set service ssh access-control deny user 'root'


# === 2. Disable Unnecessary Services ===
delete service telnet
delete service snmp
delete service tftp-server
delete service ftp-server  # This is for the router's FTP server, not for traffic


# === 3. Enable Conntrack Helpers (REQUIRED FOR FTP) ===
set system conntrack modules ftp


# === 4. Create Firewall Groups (Cleaner & Faster) ===
# --- !!! CHANGE '192.168.1.50' TO YOUR SERVER IP !!! ---
set firewall group network-group SCORED_SERVERS network '192.168.1.50/32'

# Group for scored TCP services
set firewall group port-group SCORED_TCP_PORTS port '21'  # FTP
set firewall group port-group SCORED_TCP_PORTS port '25'  # SMTP
set firewall group port-group SCORED_TCP_PORTS port '53'  # DNS-TCP
set firewall group port-group SCORED_TCP_PORTS port '80'  # HTTP
set firewall group port-group SCORED_TCP_PORTS port '110' # POP3
set firewall group port-group SCORED_TCP_PORTS port '443' # HTTPS

# Group for scored UDP services
set firewall group port-group SCORED_UDP_PORTS port '53'  # DNS-UDP


# === 5. WAN_LOCAL Firewall (Protects the Router) ===
set firewall name WAN_LOCAL default-action 'drop'
set firewall name WAN_LOCAL description 'Protects router management plane'

# Rule 10: Allow return traffic (Syntax for 1.4.3)
set firewall name WAN_LOCAL rule 10 action 'accept'
set firewall name WAN_LOCAL rule 10 state established 'enable'
set firewall name WAN_LOCAL rule 10 state related 'enable'

# Rule 20: Allow Admin SSH
set firewall name WAN_LOCAL rule 20 action 'accept'
set firewall name WAN_LOCAL rule 20 description 'Allow Admin SSH (4971)'
set firewall name WAN_LOCAL rule 20 destination port '4971'
set firewall name WAN_LOCAL rule 20 protocol 'tcp'

# Rule 30: Allow Ping (for scoring checks)
set firewall name WAN_LOCAL rule 30 action 'accept'
set firewall name WAN_LOCAL rule 30 description 'Allow ICMP'
set firewall name WAN_LOCAL rule 30 protocol 'icmp'


# === 6. WAN_FORWARD Firewall (Protects the Services) ===
set firewall name WAN_FORWARD default-action 'drop'
set firewall name WAN_FORWARD description 'Allows scored services to internal servers'

# Rule 10: Allow return traffic (Syntax for 1.4.3)
set firewall name WAN_FORWARD rule 10 action 'accept'
set firewall name WAN_FORWARD rule 10 state established 'enable'
set firewall name WAN_FORWARD rule 10 state related 'enable'

# Rule 100: Allow Scored TCP Services
set firewall name WAN_FORWARD rule 100 action 'accept'
set firewall name WAN_FORWARD rule 100 description 'Allow Scored TCP'
set firewall name WAN_FORWARD rule 100 destination group network-group 'SCORED_SERVERS'
set firewall name WAN_FORWARD rule 100 destination group port-group 'SCORED_TCP_PORTS'
set firewall name WAN_FORWARD rule 100 protocol 'tcp'

# Rule 101: Allow Scored UDP Services
set firewall name WAN_FORWARD rule 101 action 'accept'
set firewall name WAN_FORWARD rule 101 description 'Allow Scored UDP'
set firewall name WAN_FORWARD rule 101 destination group network-group 'SCORED_SERVERS'
set firewall name WAN_FORWARD rule 101 destination group port-group 'SCORED_UDP_PORTS'
set firewall name WAN_FORWARD rule 101 protocol 'udp'


# === 7. Apply Firewalls to WAN Interface ===
# --- !!! CHANGE 'eth0' TO YOUR ACTUAL WAN INTERFACE !!! ---
# (Use 'run show interfaces' to check)
set interfaces ethernet eth0 firewall local name 'WAN_LOCAL'
set interfaces ethernet eth0 firewall in name 'WAN_FORWARD'


# === 8. Commit and Save ===
commit
save
exit

echo "Configuration applied and saved. Exiting."
exit
